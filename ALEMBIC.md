# Alembic Migration Guide (FastAPI + SQLAlchemy + Poetry)

This guide explains, in a **clean and structured way**, how to work with Alembic migrations the right way.

It includes:

* Creating migration files
* Autogenerate migrations
* Applying migrations
* Rolling back migrations
* Checking history
* Workflow order
* Poetry commands

---

## 1. Create a New Migration File

### **A) Empty Migration (manual)**

Use when you want to write SQL/DDL manually.

```
alembic revision --empty -m "create audit_logs table"
```

Using Poetry:

```
poetry run alembic revision --empty -m "create audit_logs table"
```

---

### **B) Autogenerated Migration (from models)**

Alembic compares models vs DB and creates the diff.

```
alembic revision --autogenerate -m "add last_login column"
```

Using Poetry:

```
poetry run alembic revision --autogenerate -m "add last_login column"
```

ðŸ’¡ **IMPORTANT:** Always review the generated file before applying.

---

## 2. Apply Migrations (Upgrade)

Upgrade database to the latest migration:

```
alembic upgrade head
```

Using Poetry:

```
poetry run alembic upgrade head
```

Upgrade to a specific revision:

```
alembic upgrade <revision_id>
```

---

## 3. Roll Back Migrations (Downgrade)

### Roll back 1 migration:

```
alembic downgrade -1
```

Using Poetry:

```
poetry run alembic downgrade -1
```

### Roll back everything to base (empty database):

```
alembic downgrade base
```

Using Poetry:

```
poetry run alembic downgrade base
```

---

## 4. Check Migration Status & History

### **Show all migration history (full list):**

```
alembic history
```

Using Poetry:

```
poetry run alembic history
```

---

### **Show current database version:**

```
alembic current
```

Using Poetry:

```
poetry run alembic current
```

---

### **Show latest revision (head):**

```
alembic heads
```

Using Poetry:

```
poetry run alembic heads
```

---

## 5. Typical Development Workflow

1. **Modify SQLAlchemy models** (add column, table, relation, etc.)
2. Generate migration:

   ```
   poetry run alembic revision --autogenerate -m "update users table"
   ```
3. **Review migration file** (VERY important!)
4. Apply migration:

   ```
   poetry run alembic upgrade head
   ```
5. If something is wrong:

   ```
   poetry run alembic downgrade -1
   ```
6. Fix migration â†’ regenerate â†’ upgrade again.

---

## 6. Writing Manual Migration Operations

### Create a table:

```
op.create_table(
    'profiles',
    sa.Column('id', sa.String(32), primary_key=True),
    sa.Column('email', sa.String, unique=True),
)
```

### Add a column:

```
op.add_column('users', sa.Column('last_login', sa.DateTime()))
```

### Drop a column:

```
op.drop_column('users', 'age')
```

### Add an index:

```
op.create_index('idx_users_email', 'users', ['email'])
```

### Add foreign key:

```
op.create_foreign_key(
    'fk_users_profile',
    'users', 'profiles',
    ['profile_id'], ['id'],
    ondelete='CASCADE'
)
```

---

##  7. Production-Safe Best Practices

* **NEVER edit a migration after it's applied to production**.
* Make a new migration for every schema change.
* Always test migrations locally:

  * upgrade
  * downgrade
  * upgrade again
* Keep models in sync with the database.
* Review autogenerated migrations carefully.

---

##  8. Complete Cheat Sheet

### **Create Migration**

```
alembic revision --empty -m "msg"
alembic revision --autogenerate -m "msg"
```

### **Apply Migration**

```
alembic upgrade head
alembic upgrade <revision_id>
```

### **Rollback Migration**

```
alembic downgrade -1
alembic downgrade base
```

### **History / Status**

```
alembic history
alembic current
alembic heads
```

### **Poetry Versions**

```
poetry run alembic upgrade head
poetry run alembic downgrade -1
poetry run alembic downgrade base
poetry run alembic history
poetry run alembic heads
poetry run alembic revision --autogenerate -m "msg"
```

---
